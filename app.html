<!doctype html>

<title>Test node</title>

<h1>Post tasks</h1>

<textarea cols="100" rows="20" id="module">
(module
  ;; Recursive factorial
  (func (export "fac-rec") (param i64) (result i64)
    (if (result i64) (i64.eq (get_local 0) (i64.const 0))
      (then (i64.const 1))
      (else
        (i64.mul (get_local 0) (call 0 (i64.sub (get_local 0) (i64.const 1))))
      )
    )
  )
)
(invoke "fac-rec" (i64.const 25))
</textarea>
<p>

<div hidden>    
<h2>Simulate input from blockchain</h2>

<div id="inputs"></div>
</div>

<button onclick="newTask();">New task</button>

<div id="success"></div>

<h1>Solver</h1>

<input type="checkbox" class="error" id="solver_error">Make an error at position <input type="number" id="solver_location"  class="error" value="100">

<div id="posted"></div>

<div id="solve_success"></div>

<h1>Verifier</h1>

<input type="checkbox" class="error" id="verifier_error">Make an error at position <input type="number" id="verifier_location"   class="error" value="100">

<div id="solved"></div>

<script src="socketio.js"></script>

<script>
    
    function makeInputs() {
        var elem = document.querySelector("#inputs")
        var res = ""
        for (var i = 0; i < 64; i++) {
            res += i + ': <input type="text" value="0x0000000000000000">'
            if (i % 4 == 3) res += '<br>'
        }
        elem.innerHTML += res
    }
    
    makeInputs()
    
    function getInput() {
        var elems = document.querySelectorAll("#inputs input")
        var res = []
        for (var i = 0; i < elems.length; i++) {
            res.push(elems[i].value)
        }
        return res
    }
    
    function printObject(obj) {
        var res = "<p>Message <ul>"
        for (var i in obj) {
            res += "<li>" + i + ": " + JSON.stringify(obj[i])
        }
        return res + "</ul>"
    }
    
    var host = document.location.hostname
    
    var socket = io(host + ":22448")
    socket.on("client", () => console.log("Got message!"))
    socket.on("posted", function (obj) {
        console.log(obj)
        document.querySelector("#posted").innerHTML += "<br>" + printObject(obj)
    })
    socket.on("solved", function (obj) {
        console.log(obj)
        document.querySelector("#solved").innerHTML += "<br>" + printObject(obj)
    })
    socket.on("task_success", function (id) {
        document.querySelector("#success").innerHTML += "<br>" + id
    })
    socket.on("solve_success", function (id) {
        document.querySelector("#solve_success").innerHTML += "<br>" + id
    })
    socket.on("challenge", function (obj) {
        document.querySelector("#posted").innerHTML += "<br>" + printObject(obj)
    })
    socket.on("reply", function (obj) {
        document.querySelector("#solved").innerHTML += "<br>" + printObject(obj)
    })
    socket.on("query", function (obj) {
        document.querySelector("#posted").innerHTML += "<br>" + printObject(obj)
    })
    socket.on("phases", function (obj) {
        document.querySelector("#solved").innerHTML += "<br>" + printObject(obj)
    })
    socket.on("phase_selected", function (obj) {
        document.querySelector("#posted").innerHTML += "<br>" + printObject(obj)
    })
    
    function handleErrorUI() {
        var e1 = document.querySelector("#solver_error")
        var e2 = document.querySelector("#solver_location")
        var e3 = document.querySelector("#verifier_error")
        var e4 = document.querySelector("#verifier_location")
        socket.emit("setup_error", {
            solver_error: e1.checked, solver_location: e2.value,
            verifier_error: e3.checked, verifier_location: e4.value
        })
        console.log("changed configuration")
    }
    
    function initErrorUI() {
        var lst = document.querySelectorAll(".error");
        for (var i = 0; i < lst.length; i++) lst[i].onchange = handleErrorUI
    }
    
    initErrorUI()
    
    
    function newTask() {
        socket.emit("new_task", {task:document.querySelector("#module").value, input:getInput()})
    }
    
</script>


